@model Inbox0.Web.Models.ViewModels.InboxViewModel;

@if(Model.LoadedConversations.Count == 0)
{
    <p style="text-align: center; color: #eee">Nothing to see here</p>
}
else
{
    <div id="inbox-control-panel" class="hidden">
        <button id="archive-button" class="inbox-control">archive</button>
        <button id="delete-button" class="inbox-control">delete</button>
    </div>
    <table class="table table-dark">
        <thead>
            <tr>
                <th><input id="main-checkbox" type="checkbox"/></th>
                <th>Od</th>
                <th>Tytuł</th>
                <th>Data</th>
            </tr>
        </thead>
        <tbody>
            @foreach(var convo in Model.LoadedConversations)
            {
                <tr class="inbox-item" onclick="loadConvoPartial('@convo.Id');">
                    <td><input name="@convo.Id"  class="inbox-item-checkbox" type="checkbox"/></td>
                    <td>@convo.From</td>
                    <td>@convo.Subject</td>
                    <td>@convo.LastMessageDate</td>
                </tr>
            }
        </tbody>
    </table> 
}

<script src="https://code.jquery.com/jquery-3.1.1.min.js"></script>
<script type="text/javascript">
    function triggerControlPanel() {
        let checkboxes = document.getElementsByClassName('inbox-item-checkbox');
        let anyChecked = false;
        for(let i = 0; i < checkboxes.length; i++) {
            let isChecked = $(checkboxes[i]).prop('checked');
            if(isChecked) anyChecked = true;
        }

        if(anyChecked) {
            $('#inbox-control-panel').removeClass('hidden');
        }
        else {
            $('#inbox-control-panel').addClass('hidden');
        }
    }

    function loadConvoPartial(convoId) {
        $.ajax('/Mail/OpenConversation', {
            method: 'POST',
            data: JSON.stringify({conversationId: convoId}),
            contentType: 'application/json'
        }).done((res) => {
            $('#inbox-table-container').html(res);
        });
    }

    $('#main-checkbox').change((val) => {
        let checkboxes = document.getElementsByClassName('inbox-item-checkbox');
        allChecked = !allChecked;
        for(let i = 0; i < checkboxes.length; i++) {
            $('.inbox-item-checkbox').prop('checked', allChecked);
        }
        triggerControlPanel();
    });

    $('.inbox-item-checkbox').click(() => {
        console.log('click');
        triggerControlPanel();
    });

    $('#archive-button').click(() => {
        let checkboxes = document.getElementsByClassName('inbox-item-checkbox');
        let ids = [];
        let mailId = '@Model.SelectedMailAccountId';
        for(let i = 0; i < checkboxes.length; i++) {
            let isChecked = $(checkboxes[i]).prop('checked');
            let id = $(checkboxes[i]).attr('name');

            if(isChecked) ids.push(id);
        }

        let idsParam = ids.join('|');

        $.ajax(`/Mail/MoveToArchive?ids=${idsParam}&mailId=${mailId}`, {
            method: 'GET'
        }).done(() => {
            location.reload();
        });
    });

    $('#delete-button').click(() => {
        console.log('usuwanie');
    })

</script>

